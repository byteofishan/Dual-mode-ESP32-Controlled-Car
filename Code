#include <WiFi.h>
#include <WebServer.h>

const char* ssid = "ESP32-CAR";
const char* password = "12345678";

// ---------------- Pin Definitions ----------------
#define enA 14
#define in1 27
#define in2 26
#define in3 25
#define in4 33
#define enB 32
#define L_S 34
#define R_S 35
#define echo 22
#define trigger 23
#define servo 13

// ---------------- Variables ----------------
int Set = 15;
int distance_L = 0, distance_F = 0, distance_R = 0;
bool autoMode = true; // true = auto, false = manual
String statusMsg = "Idle";

WebServer server(80);

// ---------------- Setup ----------------
void setup() {
  Serial.begin(115200);

  pinMode(R_S, INPUT);
  pinMode(L_S, INPUT);
  pinMode(echo, INPUT);
  pinMode(trigger, OUTPUT);
  pinMode(enA, OUTPUT);
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
  pinMode(in3, OUTPUT);
  pinMode(in4, OUTPUT);
  pinMode(enB, OUTPUT);
  pinMode(servo, OUTPUT);

  analogWrite(enA, 200);
  analogWrite(enB, 200);

  // Servo initial scan
  for (int angle = 70; angle <= 140; angle += 5) servoPulse(servo, angle);
  for (int angle = 140; angle >= 0; angle -= 5) servoPulse(servo, angle);
  for (int angle = 0; angle <= 70; angle += 5) servoPulse(servo, angle);

  distance_F = Ultrasonic_read();

  // Wi-Fi setup
  WiFi.softAP(ssid, password);
  Serial.print("Wi-Fi AP IP: ");
  Serial.println(WiFi.softAPIP());

  // Server routes
  server.on("/", handleRoot);
  server.on("/F", []() { forword(); statusMsg = "Forward"; server.send(200, "text/plain", "F"); });
  server.on("/B", []() { backword(); statusMsg = "Backward"; server.send(200, "text/plain", "B"); });
  server.on("/L", []() { turnLeft(); statusMsg = "Left"; server.send(200, "text/plain", "L"); });
  server.on("/R", []() { turnRight(); statusMsg = "Right"; server.send(200, "text/plain", "R"); });
  server.on("/S", []() { Stop(); statusMsg = "Stopped"; server.send(200, "text/plain", "S"); });
  server.on("/mode", toggleMode);
  server.on("/data", sendSensorData); // JSON endpoint for dashboard

  server.begin();
  Serial.println("Server started");
}

// ---------------- Loop ----------------
void loop() {
  server.handleClient();
  if (autoMode) {
    autoDrive();
  }
}

// ---------------- Mode Toggle ----------------
void toggleMode() {
  autoMode = !autoMode;
  statusMsg = autoMode ? "Auto Mode Active" : "Manual Mode Active";
  Serial.println("Mode toggled to: " + statusMsg);
  server.send(200, "text/html", pageHTML("Mode switched!"));
}

// ---------------- Auto Driving ----------------
void autoDrive() {
  distance_F = Ultrasonic_read();
  Serial.print("D F="); Serial.println(distance_F);

  if ((digitalRead(R_S) == 0) && (digitalRead(L_S) == 0)) {
    if (distance_F > Set) { forword(); statusMsg = "Forward"; }
    else { Check_side(); }
  } else if ((digitalRead(R_S) == 1) && (digitalRead(L_S) == 0)) {
    turnRight(); statusMsg = "Turning Right";
  } else if ((digitalRead(R_S) == 0) && (digitalRead(L_S) == 1)) {
    turnLeft(); statusMsg = "Turning Left";
  }

  delay(10);
}

// ---------------- Sensor Data (for dashboard) ----------------
void sendSensorData() {
  String json = "{";
  json += "\"mode\":\"" + String(autoMode ? "Auto" : "Manual") + "\",";
  json += "\"DF\":" + String(distance_F) + ",";
  json += "\"DL\":" + String(distance_L) + ",";
  json += "\"DR\":" + String(distance_R) + ",";
  json += "\"LS\":" + String(digitalRead(L_S)) + ",";
  json += "\"RS\":" + String(digitalRead(R_S)) + ",";
  json += "\"status\":\"" + statusMsg + "\"";
  json += "}";
  server.send(200, "application/json", json);
}

// ---------------- Helper Functions ----------------
void servoPulse(int pin, int angle) {
  int pwm = (angle * 11) + 500;
  digitalWrite(pin, HIGH);
  delayMicroseconds(pwm);
  digitalWrite(pin, LOW);
  delay(20);
}

long Ultrasonic_read() {
  digitalWrite(trigger, LOW);
  delayMicroseconds(2);
  digitalWrite(trigger, HIGH);
  delayMicroseconds(10);
  long time = pulseIn(echo, HIGH, 20000);
  if (time == 0) return 999;
  return time / 29 / 2;
}

void compareDistance() {
  if (distance_L > distance_R) {
    turnLeft(); delay(500);
    forword(); delay(600);
    turnRight(); delay(500);
    forword(); delay(600);
    turnRight(); delay(400);
  } else {
    turnRight(); delay(500);
    forword(); delay(600);
    turnLeft(); delay(500);
    forword(); delay(600);
    turnLeft(); delay(400);
  }
}

void Check_side() {
  Stop(); delay(100);

  for (int angle = 70; angle <= 140; angle += 5) servoPulse(servo, angle);
  delay(300);
  distance_R = Ultrasonic_read();

  for (int angle = 140; angle >= 0; angle -= 5) servoPulse(servo, angle);
  delay(300);
  distance_L = Ultrasonic_read();

  for (int angle = 0; angle <= 70; angle += 5) servoPulse(servo, angle);
  delay(300);

  compareDistance();
}

// ---------------- Motor Functions ----------------
void forword() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}

void backword() {
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
}

void turnRight() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
}

void turnLeft() {
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}

void Stop() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
}

// ---------------- Web Page ----------------
String pageHTML(String msg) {
  String mode = autoMode ? "Auto Mode" : "Manual Mode";
  String html = R"rawliteral(
  <!DOCTYPE html>
  <html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        text-align: center;
        font-family: Arial;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
      }
      h2 { margin-top: 10px; }
      button {
        width: 90px; height: 90px;
        font-size: 32px; margin: 10px;
        border-radius: 20px; border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        background-color: white;
      }
      button:active { background-color: #d4d4d4; }
      .mode {
        background: #4CAF50; color: white;
        font-size: 18px; padding: 12px 25px;
        border-radius: 12px; margin-bottom: 20px;
      }
      .controls { display: flex; flex-direction: column; align-items: center; }
      .row { display: flex; justify-content: center; }
      #dashboard {
        background: white; padding: 15px; margin-top: 15px;
        border-radius: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        display: inline-block;
      }
      table { width: 100%; font-size: 18px; }
    </style>
  </head>
  <body>
    <h2> ESP32 Dual Mode Smart Car</h2>
    <h3>Current Mode: )rawliteral" + mode + R"rawliteral(</h3>
    <button class='mode' onclick="location.href='/mode'">Toggle Mode</button>
  )rawliteral";

  if (!autoMode) {
    html += R"rawliteral(
      <div class='controls'>
        <div class='row'>
          <button onmousedown="send('F')" ontouchstart="send('F')" onmouseup="send('S')" ontouchend="send('S')">F</button>
        </div>
        <div class='row'>
          <button onmousedown="send('L')" ontouchstart="send('L')" onmouseup="send('S')" ontouchend="send('S')">L</button>
          <button onmousedown="send('S')" ontouchstart="send('S')">S</button>
          <button onmousedown="send('R')" ontouchstart="send('R')" onmouseup="send('S')" ontouchend="send('S')">R</button>
        </div>
        <div class='row'>
          <button onmousedown="send('B')" ontouchstart="send('B')" onmouseup="send('S')" ontouchend="send('S')">B</button>
        </div>
      </div>
    )rawliteral";
  } else {
    html += R"rawliteral(
      <div id="dashboard">
        <h3> Live Sensor Data</h3>
        <table>
          <tr><td>Front Distance:</td><td id="df">--</td></tr>
          <tr><td>Left Distance:</td><td id="dl">--</td></tr>
          <tr><td>Right Distance:</td><td id="dr">--</td></tr>
          <tr><td>Left Sensor:</td><td id="ls">--</td></tr>
          <tr><td>Right Sensor:</td><td id="rs">--</td></tr>
          <tr><td>Status:</td><td id="st">--</td></tr>
        </table>
      </div>
      <script>
        setInterval(()=>{
          fetch('/data').then(r=>r.json()).then(j=>{
            document.getElementById('df').innerText=j.DF+' cm';
            document.getElementById('dl').innerText=j.DL+' cm';
            document.getElementById('dr').innerText=j.DR+' cm';
            document.getElementById('ls').innerText=j.LS==0?'White':'Black';
            document.getElementById('rs').innerText=j.RS==0?'White':'Black';
            document.getElementById('st').innerText=j.status;
          });
        },1000);
      </script>
    )rawliteral";
  }

  html += R"rawliteral(
    <script>
      function send(cmd){fetch('/'+cmd);}
    </script>
  </body>
  </html>
  )rawliteral";

  return html;
}

void handleRoot() {
  server.send(200, "text/html", pageHTML("Ready"));
}
